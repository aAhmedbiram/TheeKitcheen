{% extends "base.html" %}
{% block content %}
<div class="menu-container">
    <h1 class="menu-title">{{ t.menu }}</h1>

    <!-- Category Filter Tabs -->
    <div class="category-tabs">
        <a href="{{ url_for('menu', category='all') }}"
            class="category-tab {% if current_category == 'all' %}active{% endif %}">
            {{ t.all_categories if t.all_categories is defined else 'All Categories' }}
        </a>
        {% for cat_key, label in category_names.items() %}
        <a href="{{ url_for('menu', category=cat_key) }}"
            class="category-tab {% if current_category == cat_key %}active{% endif %}">
            {{ label.name_ar if current_lang == 'ar' else label.name_en }}
        </a>
        {% endfor %}
    </div>

    <!-- Menu Items Grid -->
    <div class="menu-grid">
        {% if not has_items %}
        <div class="empty-cart-message">
            <p>{{ t.no_items_in_category if t.no_items_in_category is defined else 'No items found in this category.' }}
            </p>
        </div>
        {% else %}
        {% for cat_key, label in category_names.items() %}
        {% set cat_data = categories.get(cat_key) %}
        {% if cat_data and (current_category == 'all' or current_category == cat_key) and cat_data['items'] %}
        <div class="category-section">
            <h2 class="category-title">{{ label.name_ar if current_lang == 'ar' else label.name_en }}</h2>
            <div class="items-grid">
                {% for item in cat_data['items'] %}
                <div class="menu-item-card">
                    <div class="item-image">
                        {% if item.image_urls and item.image_urls.strip() %}
                        <img src="{{ item.image_urls }}" alt="{{ item.get_name(current_lang) }}" class="food-image">
                        {% else %}
                        <span class="food-emoji">{{ item.get_display_image() }}</span>
                        {% endif %}
                    </div>
                    <div class="item-details">
                        <h3 class="item-name">{{ item.get_name(current_lang) }}</h3>
                        <p class="item-description">{{ item.get_description(current_lang) }}</p>
                        <div class="item-footer">
                            <span class="item-price">{{ item.price }} EGP</span>
                            <button class="add-to-cart-btn" data-item-id="{{ item.id }}"
                                data-item-name="{{ item.get_name(current_lang) }}" data-item-price="{{ item.price }}"
                                onclick="addToCart(this)">
                                <span class="btn-icon">ðŸ›’</span>
                                <span class="btn-text">{{ t.add_to_cart if t.add_to_cart is defined else 'Add to Cart'
                                    }}</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Cart Sidebar -->
<div id="cartSidebar" class="cart-sidebar">
    <div class="cart-header">
        <h3>{{ t.cart if t.cart is defined else 'Cart' }}</h3>
        <button class="close-cart" onclick="toggleCart()">Ã—</button>
    </div>
    <div class="cart-items" id="cartItems">
        <!-- Cart items will be dynamically added here -->
    </div>
    <div class="cart-footer">
        <div class="cart-total">
            <span>{{ t.total if t.total is defined else 'Total' }}: </span>
            <span id="cartTotal">0 EGP</span>
        </div>
        <button class="checkout-btn" onclick="goToCheckout()">
            {{ t.checkout if t.checkout is defined else 'Checkout' }}
        </button>
    </div>
</div>

<!-- Floating Cart Button -->
<div class="floating-cart-btn" onclick="toggleCart()">
    <span class="cart-icon">ðŸ›’</span>
    <span class="cart-count" id="cartCount">0</span>
</div>

<script>
    // Simple i18n object to avoid template parsing issues
    const i18n = {
        added: "{{ t.added_to_cart if t.added_to_cart is defined else 'Added to cart!' }}",
        emptyCart: "{{ t.empty_cart if t.empty_cart is defined else 'Your cart is empty' }}",
        emptyCheckout: "{{ t.empty_cart_checkout if t.empty_cart_checkout is defined else 'Your cart is empty! Add items before checkout.' }}",
        placed: "{{ t.order_placed if t.order_placed is defined else 'Order placed successfully!' }}",
        egp: "EGP"
    };
</script>

<script>
    let cart = [];

    // Cart persistence functions
    function loadCart() {
        try {
            cart = JSON.parse(localStorage.getItem('cart') || '[]');
        } catch (e) {
            cart = [];
        }
    }

    function saveCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
    }

    function addToCart(button) {
        const itemId = parseInt(button.dataset.itemId);
        const itemName = button.dataset.itemName;
        const price = parseFloat(button.dataset.itemPrice);

        // Visual feedback
        button.classList.add('added');
        setTimeout(() => button.classList.remove('added'), 600);

        // Call server-side add_to_cart function
        fetch('/add_to_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: 1
            })
        })
            .then(response => response.json())
            .then(data => {
                console.log('Add to cart response:', data); // Debug log
                if (data.success) {
                    // Update cart count in floating cart button
                    const cartCount = document.getElementById('cartCount');
                    cartCount.textContent = data.cart_count;

                    // Show notification
                    showNotification(i18n.added);

                    // Always update cart display from server
                    loadCartFromServer();
                } else {
                    console.error('Add to cart failed:', data); // Debug log
                    showNotification(data.message);
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                showNotification('Error adding item to cart');
            });
    }

    function removeFromCart(itemId) {
        cart = cart.filter(item => item.id !== itemId);
        updateCart();
        saveCart();
    }

    function updateQuantity(itemId, change) {
        const item = cart.find(item => item.id === itemId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(itemId);
            } else {
                updateCart();
                saveCart();
            }
        }
    }

    function updateCart() {
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        const cartTotal = document.getElementById('cartTotal');

        if (cart.length === 0) {
            cartItems.innerHTML = '<p class="empty-cart">' + i18n.emptyCart + '</p>';
            cartCount.textContent = '0';
            cartTotal.textContent = '0 ' + i18n.egp;
            return;
        }

        let total = 0;
        let count = 0;

        cartItems.innerHTML = cart.map(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            count += item.quantity;

            return '<div class="cart-item">' +
                '<div class="cart-item-info">' +
                '<h4>' + item.name + '</h4>' +
                '<p>' + item.price + ' ' + i18n.egp + '</p>' +
                '</div>' +
                '<div class="cart-item-controls">' +
                '<button onclick="updateQuantity(' + item.id + ', -1)">-</button>' +
                '<span>' + item.quantity + '</span>' +
                '<button onclick="updateQuantity(' + item.id + ', 1)">+</button>' +
                '<button onclick="removeFromCart(' + item.id + ')" class="remove-btn">Ã—</button>' +
                '</div>' +
                '</div>';
        }).join('');

        cartCount.textContent = count;
        cartTotal.textContent = total + ' ' + i18n.egp;
    }

    function toggleCart() {
        const cartSidebar = document.getElementById('cartSidebar');
        cartSidebar.classList.toggle('open');
    }

    function goToCheckout() {
        // Close cart sidebar
        const cartSidebar = document.getElementById('cartSidebar');
        cartSidebar.classList.remove('open');

        // Redirect to checkout page
        window.location.href = '/checkout';
    }

    function checkout() {
        if (cart.length === 0) {
            alert(i18n.emptyCheckout);
            return;
        }

        // Here you would typically send the cart data to the server
        alert(i18n.placed);
        cart = [];
        saveCart();
        updateCart();
        toggleCart();
    }

    function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Load cart from server on page load
    function loadCartFromServer() {
        console.log('Loading cart from server...'); // Debug log
        fetch('/get_cart')
            .then(response => {
                console.log('Get cart response status:', response.status); // Debug log
                return response.json();
            })
            .then(data => {
                console.log('Get cart data:', data); // Debug log
                if (data.success) {
                    cart = data.cart || [];
                    console.log('Cart loaded from server:', cart); // Debug log
                    updateCartDisplay();

                    // Update cart count
                    const cartCount = document.getElementById('cartCount');
                    cartCount.textContent = data.cart_count || 0;
                    console.log('Cart count updated to:', data.cart_count); // Debug log
                } else {
                    console.error('Failed to load cart:', data); // Debug log
                    showNotification('Error loading cart');
                }
            })
            .catch(error => {
                console.error('Error loading cart:', error); // Debug log
                showNotification('Error loading cart');
            });
    }

    function updateQuantityServer(itemId, change) {
        console.log('Updating quantity on server...'); // Debug log
        fetch('/update_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                item_id: itemId,
                change: change
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cart = data.cart;
                    updateCartDisplay();

                    // Update cart count
                    const cartCount = document.getElementById('cartCount');
                    cartCount.textContent = data.cart_count || 0;
                }
            })
            .catch(error => {
                console.error('Error updating cart:', error);
                showNotification('Error updating cart');
            });
    }

    function removeFromCartServer(itemId) {
        fetch('/remove_from_cart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                item_id: itemId
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cart = data.cart;
                    updateCartDisplay();

                    // Update cart count
                    const cartCount = document.getElementById('cartCount');
                    cartCount.textContent = data.cart_count || 0;
                }
            })
            .catch(error => {
                console.error('Error removing from cart:', error);
                showNotification('Error removing item from cart');
            });
    }

    function updateCartDisplay() {
        const cartItems = document.getElementById('cartItems');
        const cartTotal = document.getElementById('cartTotal');
        const cartCount = document.getElementById('cartCount');

        console.log('Updating cart display with cart:', cart); // Debug log

        if (cart.length === 0) {
            cartItems.innerHTML = '<p class="empty-cart">' + i18n.emptyCart + '</p>';
            cartTotal.textContent = '0 ' + i18n.egp;
            cartCount.textContent = '0';
            return;
        }

        let total = 0;
        let count = 0;

        cartItems.innerHTML = cart.map(item => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            count += item.quantity;

            console.log('Rendering item:', item); // Debug log

            return '<div class="cart-item">' +
                '<div class="cart-item-info">' +
                '<h4>' + item.name + '</h4>' +
                '<p>' + item.price + ' ' + i18n.egp + '</p>' +
                '</div>' +
                '<div class="cart-item-controls">' +
                '<button onclick="updateQuantityServer(' + item.id + ', -1)">-</button>' +
                '<span>' + item.quantity + '</span>' +
                '<button onclick="updateQuantityServer(' + item.id + ', 1)">+</button>' +
                '<button onclick="removeFromCartServer(' + item.id + ')" class="remove-btn">Ã—</button>' +
                '</div>' +
                '</div>';
        }).join('');

        cartTotal.textContent = total + ' ' + i18n.egp;
        cartCount.textContent = count;

        console.log('Cart display updated - Total:', total, 'Count:', count); // Debug log
    }

    // Initialize cart on page load
    loadCartFromServer();
</script>

<style>
    .menu-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .menu-title {
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 30px;
        background: linear-gradient(135deg, #4caf50, #66d66a);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .category-tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }

    .category-tab {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        padding: 12px 24px;
        border-radius: 25px;
        text-decoration: none;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    .category-tab:hover,
    .category-tab.active {
        background: linear-gradient(135deg, #4caf50, #66d66a);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .category-section {
        margin-bottom: 50px;
    }

    .category-title {
        font-size: 1.8rem;
        margin-bottom: 25px;
        color: #4caf50;
        text-align: center;
    }

    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
    }

    .menu-item-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        overflow: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .menu-item-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        border-color: rgba(76, 175, 80, 0.3);
    }

    .item-image {
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(102, 214, 106, 0.1));
        overflow: hidden;
    }

    .food-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.3s ease;
    }

    .food-image:hover {
        transform: scale(1.05);
    }

    .food-emoji {
        font-size: 3rem;
    }

    .item-details {
        padding: 20px;
    }

    .item-name {
        font-size: 1.2rem;
        margin-bottom: 10px;
        color: #fff;
    }

    .item-description {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .item-price {
        font-size: 1.1rem;
        font-weight: bold;
        color: #4caf50;
    }

    .add-to-cart-btn {
        background: linear-gradient(135deg, #4caf50, #66d66a);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.2);
        position: relative;
        overflow: hidden;
    }

    .add-to-cart-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .add-to-cart-btn:hover::before {
        left: 100%;
    }

    .add-to-cart-btn:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        background: linear-gradient(135deg, #45a049, #5cbf60);
    }

    .add-to-cart-btn:active {
        transform: translateY(0) scale(0.98);
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }

    .add-to-cart-btn.added {
        background: linear-gradient(135deg, #2196f3, #42a5f5);
        animation: pulse 0.6s ease;
    }

    .btn-icon {
        font-size: 1rem;
        transition: transform 0.3s ease;
    }

    .add-to-cart-btn:hover .btn-icon {
        transform: scale(1.2);
    }

    .btn-text {
        font-weight: 600;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }

        100% {
            transform: scale(1);
        }
    }

    /* Cart Sidebar */
    .cart-sidebar {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: rgba(20, 20, 30, 0.95);
        backdrop-filter: blur(20px);
        border-left: 1px solid rgba(76, 175, 80, 0.3);
        transition: right 0.3s ease;
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }

    .cart-sidebar.open {
        right: 0;
    }

    .cart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-header h3 {
        color: #fff;
        margin: 0;
    }

    .close-cart {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .cart-items {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-item-info h4 {
        margin: 0 0 5px 0;
        color: #fff;
    }

    .cart-item-info p {
        margin: 0;
        color: #4caf50;
    }

    .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .cart-item-controls button {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cart-item-controls button:hover {
        background: rgba(76, 175, 80, 0.3);
    }

    .remove-btn {
        background: rgba(244, 67, 54, 0.3) !important;
        border-color: rgba(244, 67, 54, 0.5) !important;
    }

    .cart-footer {
        padding: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 1.2rem;
        color: #fff;
    }

    .checkout-btn {
        width: 100%;
        background: linear-gradient(135deg, #4caf50, #66d66a);
        color: #fff;
        border: none;
        padding: 15px;
        border-radius: 10px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .checkout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .floating-cart-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #4caf50, #66d66a);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        transition: all 0.3s ease;
        z-index: 999;
    }

    .floating-cart-btn:hover {
        transform: scale(1.1);
    }

    .cart-icon {
        font-size: 1.5rem;
    }

    .cart-count {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #f44336;
        color: #fff;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #4caf50, #66d66a);
        color: #fff;
        padding: 15px 25px;
        border-radius: 25px;
        z-index: 2000;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translate(-50%, -20px);
        }

        to {
            opacity: 1;
            transform: translate(-50%, 0);
        }
    }

    .empty-cart {
        text-align: center;
        color: rgba(255, 255, 255, 0.5);
        padding: 20px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .cart-sidebar {
            width: 100%;
            right: -100%;
        }

        .items-grid {
            grid-template-columns: 1fr;
        }

        .category-tabs {
            gap: 5px;
        }

        .category-tab {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .menu-title {
            font-size: 2rem;
        }
    }
</style>
{% endblock %}